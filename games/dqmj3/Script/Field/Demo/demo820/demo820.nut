//=============================================
//
//		demo820[海のスターピース組み込み]
//
//=============================================

//-------------------------------------------------------------------------
//
//		読み込み・配置
//
//-------------------------------------------------------------------------
function Update()
{
// ▼フラグ設定
	local bit_green = GetEventFlg_("BFG_STAR_PIECE_EFFECT_ON_GREEN");		// Bit_1361 緑：ヤチホコ撃破フラグ
	local bit_red = GetEventFlg_("BFG_STAR_PIECE_EFFECT_ON_RED");			// Bit_1363 赤：ホアカリ撃破フラグ
	local bit_open_green = GetEventFlg_("BFG_PLAYED_YATIHOKO_SEALED_DEMO");	// Bit_1373 緑の扉が開いたか
	local bit_open_red = GetEventFlg_("BFG_PLAYED_HOAKARI_SEALED_DEMO");	// Bit_1375 赤の扉が開いたか

// ▼変数定義
	local task_cam, task_player, task_aroma;
	local task_aroma_step;
	local efc_player, efc_seed00, efc_seed01, efc_seed02, efc_kirakira00, efc_kirakira01;
	local efc_green, efc_red;

// ▼リソース読込
	// ギミック
	local model_base = ReadGimmick_("o_effect_base");		// エフェクトベース
	local model_pod = ReadGimmick_("o_U00_02");				// 脱出ポッド
	local model_red_door = ReadGimmick_("o_U00_05");		// 扉:赤扉
	local model_green_door = ReadGimmick_("o_U00_09");		// 扉:緑扉

	local model_warp_center = ReadGimmick_("o_com_35");		// 加速リング(赤)
	local model_warp_right = ReadGimmick_("o_com_36");		// 加速リング(青)
	local model_warp_left = ReadGimmick_("o_com_37");		// 加速リング(緑)

	// キャラクター
	local player = GetPlayerId_();							// 主人公
	local model_aroma000 = ReadNpc_("n018");				//アロマ
	// エフェクト
	LoadEffect_("ef732_20_star_seed_b");					// スターシード 青
	LoadEffect_("ef731_01_mag_light01");					// 白いキラキラ
	LoadEffect_("ef732_25_star_seed_base01");				// スターシード 完成する前
	LoadEffect_("ef732_23_star_seed_m_b");					// スターシード 軌道 青
	LoadEffect_("ef340_06_star_seed_case");					// スターシードの入れ物
	LoadEffect_("ef340_07_star_seed_shaton_u");				// 電気エフェクト　上
	LoadEffect_("ef340_08_star_seed_shaton_d");				// 電気エフェクト　下

// ▼配置
	// 主人公
	SetPointPos_(player, "player000");

	// アロマ
	local aroma = ArrangePointNpc_(model_aroma000, "npc_aroma000");
	SetStepSe_(aroma, SILENT_STEP_SE);

	//スターシード 完成する前
	local seed_before = ArrangePointGimmick_("o_effect_base", model_base, "obj_seed000");
	SetPointPosNoFit_(seed_before, "obj_seed000");
	efc_seed01 = SetSelectBoneEffect_("ef732_25_star_seed_base01", seed_before, ATTACH_GLOBAL);

	// ■ヤチホコを撃破している場合■
	if (bit_green)
	{
		// スターシード 軌道 緑
		LoadEffect_("ef732_22_star_seed_m_g");
		efc_green = SetSelectBoneEffect_("ef732_22_star_seed_m_g" seed_before, ATTACH_GLOBAL);
	}

	// ■ホアカリを撃破している場合■
	if (bit_red)
	{
		// スターシード 軌道 赤
		LoadEffect_("ef732_24_star_seed_m_r");
		efc_red = SetSelectBoneEffect_("ef732_24_star_seed_m_r", seed_before, ATTACH_GLOBAL);
	}

	// ■ヤチホコの指輪を見せていない場合■
	if (!bit_open_green)
	{
		// 緑扉
		local green_door = ArrangePointGimmick_("o_U00_09", model_green_door, "obj_U00_09");
	}

	// ■ホアカリの指輪を見せていない場合■
	if (!bit_open_red)
	{
		// 赤扉
		local red_door = ArrangePointGimmick_("o_U00_05", model_red_door, "obj_U00_05");
	}

	//スターシード 青
	local starseed = ArrangePointGimmick_("ef732_20_star_seed_b", model_base, "obj_starseed00");
	SetPointPosNoFit_(starseed, "obj_starseed00");
	efc_seed00 = SetSelectBoneEffect_("ef732_20_star_seed_b", starseed, ATTACH_GLOBAL);

	//スターシードの入れ物
	local efc_case = SetSelectBoneEffect_("ef340_06_star_seed_case", seed_before, ATTACH_GLOBAL);
	local efc_shaton_u = SetPointWorldEffect_("ef340_07_star_seed_shaton_u", "efc_shaton_d000");		//電気　上
	local efc_shaton_d = SetPointWorldEffect_("ef340_08_star_seed_shaton_d", "efc_shaton_u000");		//電気　下

	// ポッド
	local pod00 = ArrangePointGimmick_("o_U00_02", model_pod, "obj_pod000");
	local pod01 = ArrangePointGimmick_("o_U00_02", model_pod, "obj_pod001");
	local pod02 = ArrangePointGimmick_("o_U00_02", model_pod, "obj_pod002");
	
	local warp_center = ArrangePointGimmick_("o_com_35", model_warp_center, "obj_warp_center000");		// 加速リング(赤)
	local warp_right = ArrangePointGimmick_("o_com_36", model_warp_right, "obj_warp_right000");			// 加速リング(青)
	local warp_left = ArrangePointGimmick_("o_com_37", model_warp_left, "obj_warp_left000");			// 加速リング(緑)

// ▼非常駐モーション読込
	local aroma_star_seed_L = ReadMotion_(aroma, "n018_star_seed_L");						//スターシードを持つL
	local aroma_star_seed_look_L = ReadMotion_(aroma, "n018_star_seed_look_L");				//スターシードを見るL
	local aroma_star_seed_send = ReadMotion_(aroma, "n018_star_seed_send");					//スターシードを前へ
	local aroma_star_seed_send_L = ReadMotion_(aroma, "n018_star_seed_send_L");				//スターシードを前へL
	local aroma_star_seed_look_up_L = ReadMotion_(aroma, "n018_star_seed_look_up_L");		//スターシードを持つ(上向き)L
	local aroma_star_seed_look_left_L = ReadMotion_(aroma, "n018_star_seed_look_left_L");	//スターシードを持つ(左向き)L
	local aroma_look_right_L = ReadMotion_(aroma, "n018_look_right_L");						//アロマ 左向き
	local aroma_look_up_L = ReadMotion_(aroma, "n018_look_up_L");							//アロマ 上向き
	local player_look_up_L = ReadMotion_(player, "Player_look_up_L");						//主人公 上向き

// ▼モーション設定
	SetMotion_(aroma, aroma_star_seed_L, BLEND_N);				//スターシードを持つL

// ▼カメラ設定
	local task_cam = Task_AnimeMoveCamera_("anmeye000", "anmtgt000");

//-------------------------------------------------------------------------
//		はじまりはじまり
//-------------------------------------------------------------------------

	StartDemo(FADE_COLOR_BLACK);

	//===============================================
	// ■アロマ
	// 「海のスターピースか……。
	//-----------------------------------------------
	OpenMsgWnd_();
	SetTalkName_("NAME_TAG_AROMA");
	ShowMsg_("DEMO_820_MSG_010");
	KeyInputWait_();

	SetMotion_(aroma, aroma_star_seed_look_left_L, BLEND_XL);	//スターシードを見るL
	local task_starseed = Task_AnimeMoveNoDirNoFit_(starseed, "anm_starseed00");//スターシード00

	//-----------------------------------------------
	// ▽
	// 「アンタには　隠してたみたいだけど……。
	//-----------------------------------------------
	ShowMsg_("DEMO_820_MSG_020");
	KeyInputWait_();

	//-----------------------------------------------
	// ▽
	// 「でもね　ワダツミと戦ったときの　アイツは……
	//-----------------------------------------------
	ShowMsg_("DEMO_820_MSG_030");
	KeyInputWait_();

	//-----------------------------------------------
	// ▽
	// 「アンタたちは　やっぱり兄弟ね……そっくりよ。
	//-----------------------------------------------
	ShowMsg_("DEMO_820_MSG_040");
	KeyInputWait_();
	CloseMsgWnd_();
	//===============================================

	DeleteTask_(task_cam);
	Wait_(20);

	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓
	//■カット2
	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓

	SetPointCameraEye_("cameye000");
	SetPointCameraTarget_("camtgt000");

	SetAlpha_(player, 0);
	Wait_(40);

	SetMotion_(aroma, aroma_star_seed_look_L, BLEND_XL);		//スターシードを見るL
	Wait_(1);
	DeleteTask_(task_starseed);
	local task_starseed = Task_AnimeMoveNoDirNoFit_(starseed, "anm_starseed01");//スターシード01
	Wait_(19);

	//===============================================
	// ■アロマ
	// 「心のありようが　アンセスから
	//-----------------------------------------------
	OpenMsgWnd_();
	SetTalkName_("NAME_TAG_AROMA");
	ShowMsg_("DEMO_820_MSG_050");
	KeyInputWait_();
	CloseMsgWnd_();
	//===============================================

	SetMotion_(aroma, aroma_star_seed_send, BLEND_XL);				//スターシードを前へ
	Wait_(10);
	
	DeleteTask_(task_starseed);
	PlaySE_("SE_DEM_199");
	local task_starseed = Task_AnimeMoveNoDirNoFit_(starseed, "anm_starseed02");		//スターシード02
	WaitMotion(aroma);
	SetMotion_(aroma, aroma_star_seed_send_L, BLEND_M);				//スターシードを前へ
	
	Wait_(90);
	
	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓
	//■カット3
	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓

	local task_cam = Task_AnimeMoveCamera_("anmeye001", "anmtgt001");
	PlaySE_("SE_DEM_200");

	DeleteTask_(task_starseed);

	local task_starseed = Task_AnimeMoveNoFit_(starseed, "anm_starseed03");		//スターシード03

	SetAlpha_(player, 1);

	SetDir_(player, -120);
	SetDir_(aroma, -90);

	Wait_(90);

	SetFade_(FADE_OUT, FADE_COLOR_WHITE , 30);
	WaitFade_();

	DeleteEffectEmitter_(efc_seed00);
	SetMotion_(player, player_look_up_L, BLEND_XL);				//主人公 上向き
	SetMotion_(aroma, aroma_look_up_L, BLEND_XL);				//アロマ 上向き
	Wait_(60);

	efc_seed02 = SetSelectBoneEffect_("ef732_23_star_seed_m_b" seed_before, ATTACH_GLOBAL);
	if (bit_green)
	{
		DeleteEffect_(efc_green);
		efc_green = SetSelectBoneEffect_("ef732_22_star_seed_m_g" seed_before, ATTACH_GLOBAL);
	}
	if (bit_red)
	{
		DeleteEffect_(efc_red);
		efc_red = SetSelectBoneEffect_("ef732_24_star_seed_m_r" seed_before, ATTACH_GLOBAL);
	}


	SetFade_(FADE_IN, FADE_COLOR_WHITE , 30);
	WaitFade_();
	//-----

	Wait_(90);
	DeleteTask_(task_cam);


	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓
	//■カット4
	//〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓〓

	SetPointCameraEye_("cameye001");
	SetPointCameraTarget_("camtgt001");

	SetMotion_(aroma, MOT_WALK, BLEND_XL);							//アロマ 歩き
	task_aroma = Task_RotateToPos_(aroma, GetPos_(player), 2.0);
	task_aroma_step = Task_PlaySe_("SE_FLD_016", 15);
	Wait_(20);

	SetMotion_(aroma, MOT_WAIT, BLEND_XL);							//アロマ 待機
	DeleteTask_(task_aroma_step);
	Wait_(20);

	//===============================================
	// ■アロマ
	// 「よし！　未完成のスターシードに
	//-----------------------------------------------
	OpenMsgWnd_();
	SetTalkName_("NAME_TAG_AROMA");
	ShowMsg_("DEMO_820_MSG_060");
	KeyInputWait_();
	CloseMsgWnd_();
	//===============================================

	Wait_(20);

	EndDemo(FADE_COLOR_BLACK);
}
